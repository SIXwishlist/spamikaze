2005-05-15  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/Spamikaze.pm:
	Make the configuration reloadable by sending SIGHUP to a Spamikaze
	program.  Useful for passivetrap -d and future Spamikaze daemons.

	TODO: make sure programs use the config values directly and not a
	(possibly out of date) local copy.

	diff -u -d -u -r1.23 Spamikaze.pm
	--- Spamikaze.pm	6 Nov 2004 21:00:10 -0000	1.23
	+++ Spamikaze.pm	15 May 2005 20:25:07 -0000
	@@ -57,7 +57,7 @@

	 my $VERSION = "Spamikaze.pm Version .2\n";

	-BEGIN {
	+sub ConfigLoad {

	 	my $configfile;

	@@ -175,6 +175,13 @@
	 	}

	 	return 0;
	+}
	+
	+BEGIN {
	+	&ConfigLoad();
	+
	+	# On SIGHUP we reload the configuration
	+	$SIG{HUP} = \&ConfigLoad;
	 }

	 1;

2005-05-15  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/Spamikaze.pm:
	Make the configuration reloadable by sending SIGHUP to a Spamikaze
	program.  Useful for passivetrap -d and future Spamikaze daemons.

	TODO: make sure programs use the config values directly and not a
	(possibly out of date) local copy.

	diff -u -d -u -r1.23 Spamikaze.pm
	--- Spamikaze.pm	6 Nov 2004 21:00:10 -0000	1.23
	+++ Spamikaze.pm	15 May 2005 20:25:07 -0000
	@@ -57,7 +57,7 @@

	 my $VERSION = "Spamikaze.pm Version .2\n";

	-BEGIN {
	+sub ConfigLoad {

	 	my $configfile;

	@@ -175,6 +175,13 @@
	 	}

	 	return 0;
	+}
	+
	+BEGIN {
	+	&ConfigLoad();
	+
	+	# On SIGHUP we reload the configuration
	+	$SIG{HUP} = \&ConfigLoad;
	 }

	 1;

2005-05-14  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/passivetrap.pl:
	Avoid error messages like "Duplicate entry '206-51-237-82' for key 2".
	Patch by Jeroen van Nieuwenhuizen, verified to work here.

2005-05-04  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2005-04-03  Rik van Riel  <riel@humbolt>

	* html/menu.inc.php: link in the wiki

2005-04-02  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2005-04-03  Rik van Riel  <riel@humbolt>

	* html/menu.inc.php: link in the wiki

2005-04-02  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2005-03-28  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated


2005-03-28  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2005-03-05  Hans Wolters  <h-wolters@humbolt>

	* spamikaze/scripts/daemon.pl:
	Using the Spamikaze.pm to handle connections to the database

	* spamikaze/scripts/daemon.pl:
	K, this is the first public entrie for the daemon.

	What does it do:

	1. Delete entries older then one year (250 entries per run).
	2. Handle the expire (maximum of 500 ipnumbers per run).

	Please backup your stuff before you testdrive this and make sure
	it has the correct settings for the Spamikaze.pm, etc....

	Enjoy,

	Hans

2005-03-05  Hans Wolters  <h-wolters@humbolt>

	* spamikaze/scripts/daemon.pl:
	Using the Spamikaze.pm to handle connections to the database

	* spamikaze/scripts/daemon.pl:
	K, this is the first public entrie for the daemon.

	What does it do:

	1. Delete entries older then one year (250 entries per run).
	2. Handle the expire (maximum of 500 ipnumbers per run).

	Please backup your stuff before you testdrive this and make sure
	it has the correct settings for the Spamikaze.pm, etc....

	Enjoy,

	Hans

2005-03-04  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2005-02-06  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/smtperror-exim:
	Recognise all of these formats of error message, instead of just the
	first one:

	2005-02-06 11:12:00 SMTP protocol violation: synchronization error (input sent without waiting for greeting): rejected connection from H=[80.51.119.253]

	2005-02-06 11:11:38 SMTP protocol violation: synchronization error (next input sent too soon): rejected "Mail From: <reichbloom@yahoo.com>" H=(localhost) [217.153.19.27] next input="Rcpt To: <dmitri_3@SPAMTRAPDOMAIN>\r\n"

	2005-02-06 11:12:00 SMTP protocol violation: synchronization error (next input sent too soon): rejected "HELO localhost" H=[217.238.99.186] next input="Mail From: <jackson@yahoo.com>\r\n"

	* spamikaze/scripts/rbldnsd.pl, spamikaze/scripts/smtperror-exim:
	script that checks for SMTP protocol violations and blocklists those hosts

2005-02-06  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/smtperror-exim:
	Recognise all of these formats of error message, instead of just the
	first one:

	2005-02-06 11:12:00 SMTP protocol violation: synchronization error (input sent without waiting for greeting): rejected connection from H=[80.51.119.253]

	2005-02-06 11:11:38 SMTP protocol violation: synchronization error (next input sent too soon): rejected "Mail From: <reichbloom@yahoo.com>" H=(localhost) [217.153.19.27] next input="Rcpt To: <dmitri_3@SPAMTRAPDOMAIN>\r\n"

	2005-02-06 11:12:00 SMTP protocol violation: synchronization error (next input sent too soon): rejected "HELO localhost" H=[217.238.99.186] next input="Mail From: <jackson@yahoo.com>\r\n"

	* spamikaze/scripts/rbldnsd.pl, spamikaze/scripts/smtperror-exim:
	script that checks for SMTP protocol violations and blocklists those hosts

2005-01-28  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2004-12-11  Rik van Riel  <riel@humbolt>

	* TODO: diff -u -d -u -r1.16 TODO
	--- TODO	11 Jul 2004 21:00:03 -0000	1.16
	+++ TODO	11 Dec 2004 21:20:08 -0000
	@@ -2,16 +2,11 @@


	 Before next release:
	-  * review the documentation for completeness and skip some of the older
	-    parts where users need to include the correct path.
	-  * test the current cvs tree on different machines.
	-  * make sure database handlers are closed to make sure it will not
	-    barf out rollbacks (older perl versions).
	+  * integrate the postgres code by devdas
	+  * add similar mysql code modularisation
	+  * integrate query statistics

	 For later versions:
	-  * Add whitelist mailserver table
	-  * Add whitelist zone file so more then one mailservers can use it
	-    within a company/org.
	   * Add evidence table
	   * the perl scripts in cgi-bin should be able to do the same as there
	     php ones.

2004-12-11  Rik van Riel  <riel@humbolt>

	* TODO: diff -u -d -u -r1.16 TODO
	--- TODO	11 Jul 2004 21:00:03 -0000	1.16
	+++ TODO	11 Dec 2004 21:20:08 -0000
	@@ -2,16 +2,11 @@


	 Before next release:
	-  * review the documentation for completeness and skip some of the older
	-    parts where users need to include the correct path.
	-  * test the current cvs tree on different machines.
	-  * make sure database handlers are closed to make sure it will not
	-    barf out rollbacks (older perl versions).
	+  * integrate the postgres code by devdas
	+  * add similar mysql code modularisation
	+  * integrate query statistics

	 For later versions:
	-  * Add whitelist mailserver table
	-  * Add whitelist zone file so more then one mailservers can use it
	-    within a company/org.
	   * Add evidence table
	   * the perl scripts in cgi-bin should be able to do the same as there
	     php ones.

2004-11-23  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2004-11-13  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/passivetrap.pl:
	Clean up the maildir handling a bit, since everybody who I talked to
	seems to be using unlink instead of rename.

	NOTE: this change also gets rid of looking in the incoming/ directory,
	now you will need to SPECIFY THE ACTUAL MAILDIR on the commandline!
	This is a slightly incompatible change, but nobody objected in the
	week since it was proposed, so ... ;)

	--- passivetrap.pl	6 Nov 2004 15:51:29 -0000	1.25
	+++ passivetrap.pl	13 Nov 2004 03:28:41 -0000
	@@ -178,17 +178,15 @@
	 sub process_dir
	 {
	 	my ( $dir ) = @_;
	-	my $indir = "$dir/incoming";
	 	my $count = 0;
	 	my $file;

	-	opendir INCOMING, "$indir" || die "$ARGV[-1] : can't opendir $indir\n";
	+	opendir INCOMING, "$dir" || die "$ARGV[-1] : can't opendir $dir\n";
	 	my @files = readdir INCOMING;
	 	closedir INCOMING;

	 	foreach $file (@files) {
	-		my $mailfile = "$indir/$file";
	-		my $archived = "$dir/archive/$file";
	+		my $mailfile = "$dir/$file";
	 		my $email;

	 		# skip directories and other non-files
	@@ -205,8 +203,8 @@
	 		read MAIL, $email, 10000;
	 		close MAIL;

	-		if (!rename $mailfile, $archived) {
	-			die "can't move $mailfile to $archived: $!\n";
	+		if (!unlink $mailfile) {
	+			die "cannot unlink $mailfile: $!\n";
	 		}

	 		&process_mail($email);
	@@ -218,7 +216,6 @@
	 sub maildir_daemon
	 {
	 	my ( $dir ) = @_;
	-	my $indir = "$dir/incoming";

	 	chdir $dir || die "$ARGV[-1] : couldn't chdir to $dir\n";

2004-11-13  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/passivetrap.pl:
	Clean up the maildir handling a bit, since everybody who I talked to
	seems to be using unlink instead of rename.

	NOTE: this change also gets rid of looking in the incoming/ directory,
	now you will need to SPECIFY THE ACTUAL MAILDIR on the commandline!
	This is a slightly incompatible change, but nobody objected in the
	week since it was proposed, so ... ;)

	--- passivetrap.pl	6 Nov 2004 15:51:29 -0000	1.25
	+++ passivetrap.pl	13 Nov 2004 03:28:41 -0000
	@@ -178,17 +178,15 @@
	 sub process_dir
	 {
	 	my ( $dir ) = @_;
	-	my $indir = "$dir/incoming";
	 	my $count = 0;
	 	my $file;

	-	opendir INCOMING, "$indir" || die "$ARGV[-1] : can't opendir $indir\n";
	+	opendir INCOMING, "$dir" || die "$ARGV[-1] : can't opendir $dir\n";
	 	my @files = readdir INCOMING;
	 	closedir INCOMING;

	 	foreach $file (@files) {
	-		my $mailfile = "$indir/$file";
	-		my $archived = "$dir/archive/$file";
	+		my $mailfile = "$dir/$file";
	 		my $email;

	 		# skip directories and other non-files
	@@ -205,8 +203,8 @@
	 		read MAIL, $email, 10000;
	 		close MAIL;

	-		if (!rename $mailfile, $archived) {
	-			die "can't move $mailfile to $archived: $!\n";
	+		if (!unlink $mailfile) {
	+			die "cannot unlink $mailfile: $!\n";
	 		}

	 		&process_mail($email);
	@@ -218,7 +216,6 @@
	 sub maildir_daemon
	 {
	 	my ( $dir ) = @_;
	-	my $indir = "$dir/incoming";

	 	chdir $dir || die "$ARGV[-1] : couldn't chdir to $dir\n";

2004-11-06  Rik van Riel  <riel@humbolt>

	* html/doc/config.php:
	remove the IgnoreBOGON documentation, add in documentation for WhitelistZones

	* spamikaze/config/config.ini.example, spamikaze/scripts/Spamikaze.pm:
	Remove the IgnoreBOGON code.  This functionality can easily be obtained
	by adding bogons.cymru.com to the WhitelistZones, so this code is no
	longer required.

	--- config/config.ini.example	6 Nov 2004 15:22:54 -0000	1.9
	+++ config/config.ini.example	6 Nov 2004 20:58:29 -0000
	@@ -16,8 +16,6 @@
	 [Mail]
	 # ignore RFC1918 (private) IP addresses, don't touch this
	 IgnoreRFC1918=1
	-# ignore unassigned IP addresses, often forged, but sometimes used by spammers
	-IgnoreBOGON=0
	 # IP addresses that should not be listed, like your own mail servers
	 BackupMX=1.2.3.4 2.3.4.5
	 # ignore mail that looks like bounce messages
	--- scripts/Spamikaze.pm	6 Nov 2004 15:22:54 -0000	1.22
	+++ scripts/Spamikaze.pm	6 Nov 2004 20:58:29 -0000
	@@ -27,7 +27,6 @@
	 my $dbtype;
	 my $dbhost;
	 my @MXBACKUP;
	-my $ignoreBOGON;
	 my $ignoreRFC1918;
	 our $ignorebounces;
	 our @whitelist_zones;
	@@ -91,7 +90,6 @@
	 	@MXBACKUP = split ( ' ', $cfg->val( 'Mail', 'BackupMX' ) );
	 	@whitelist_zones = split ( ' ', $cfg->val ( 'Mail', 'WhitelistZones' ) );
	 	$ignoreRFC1918 = $cfg->val( 'Mail', 'IgnoreRFC1918' );
	-	$ignoreBOGON   = $cfg->val( 'Mail', 'IgnoreBOGON' );
	 	$ignorebounces = $cfg->val( 'Mail', 'IgnoreBounces' );

	 	$firsttime = $cfg->val ( 'Expire', 'FirstTime' );
	@@ -152,40 +150,7 @@

	 	}

	-	#
	-	# Check if the spammer doesn't somehow managed to send from a
	-	# BOGON IP-address. The BOGON test includes RFC1918 test so
	-	# we can ignore RFC1918 if we test for BOGON.
	-	#
	-	if ( $ignoreBOGON eq 'true' or $ignoreBOGON == 1) {
	-
	-		my $reversed_ip = $ip;
	-		$reversed_ip =~ s/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/$4.$3.$2.$1/;
	-		my $resolver = Net::DNS::Resolver->new;
	-		my $query    = $resolver->search("$reversed_ip.bogons.cymru.com.");
	-
	-		if ($query) {
	-
	-			foreach my $rr ( $query->answer ) {
	-
	-				next unless $rr->type eq "A";
	-				return 1;
	-
	-			}
	-
	-		}
	-		else {
	-
	-			if ( !$resolver->errorstring =~ /NXDOMAIN/ ) {
	-
	-				warn "query failed: ", $resolver->errorstring, "\n";
	-
	-			}
	-
	-		}
	-
	-	}
	-	elsif ( $ignoreRFC1918 eq 'true' or $ignoreRFC1918 == 1 ) {
	+	if ( $ignoreRFC1918 eq 'true' or $ignoreRFC1918 == 1 ) {

	 		foreach my $ipaddress (@RFC1918Addresses) {

	* spamikaze/scripts/passivetrap.pl: whitespace cleanup

	* spamikaze/config/config.ini.example, spamikaze/scripts/Spamikaze.pm, spamikaze/scripts/passivetrap.pl:
	Allow Spamikaze to use (external) DNS whitelists to avoid listing high
	volume mail servers.  This can help keep the false positives of your
	Spamikaze setup down.

	--- config/config.ini.example	29 Jun 2004 11:42:25 -0000	1.8
	+++ config/config.ini.example	6 Nov 2004 15:20:34 -0000
	@@ -22,6 +22,8 @@
	 BackupMX=1.2.3.4 2.3.4.5
	 # ignore mail that looks like bounce messages
	 IgnoreBounces=1
	+# whitelist(s) of known-good mail servers, to never block
	+WhitelistZones=whitelist.surriel.com whitelist.example.tld

	 [Expire]
	 # time (in hours) the first spam causes a host to be blocked
	--- scripts/Spamikaze.pm	29 Aug 2004 01:22:52 -0000	1.21
	+++ scripts/Spamikaze.pm	6 Nov 2004 15:20:34 -0000
	@@ -30,6 +30,7 @@
	 my $ignoreBOGON;
	 my $ignoreRFC1918;
	 our $ignorebounces;
	+our @whitelist_zones;

	 # expire.pl
	 our $firsttime;
	@@ -88,6 +89,7 @@
	 	$dbbase = $cfg->val( 'Database', 'Name' );

	 	@MXBACKUP = split ( ' ', $cfg->val( 'Mail', 'BackupMX' ) );
	+	@whitelist_zones = split ( ' ', $cfg->val ( 'Mail', 'WhitelistZones' ) );
	 	$ignoreRFC1918 = $cfg->val( 'Mail', 'IgnoreRFC1918' );
	 	$ignoreBOGON   = $cfg->val( 'Mail', 'IgnoreBOGON' );
	 	$ignorebounces = $cfg->val( 'Mail', 'IgnoreBounces' );
	--- scripts/passivetrap.pl	6 Nov 2004 05:35:52 -0000	1.23
	+++ scripts/passivetrap.pl	6 Nov 2004 15:20:34 -0000
	@@ -14,6 +14,7 @@
	 use strict;
	 use warnings;
	 use FindBin;
	+use Net::DNS;
	 use lib "$FindBin::Bin";

	 use Spamikaze;
	@@ -139,6 +140,22 @@

	 }

	+sub whitelisted
	+{
	+	my ( $revip ) = @_;
	+	$revip =~ s/(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/$4.$3.$2.$1/;
	+	my $res = new Net::DNS::Resolver;
	+	my $zone;
	+
	+	foreach $zone (@Spamikaze::whitelist_zones) {
	+		my $query = $res->query($revip . "." . $zone, "A");
	+		if (defined $query) {
	+			return 1;
	+		}
	+	}
	+	return 0;
	+}
	+
	 sub process_mail
	 {
	 	my ( $mail ) = @_;
	@@ -149,7 +166,7 @@

	 	while ($mail =~ /Received:(.*?)(?=\n\w)/sg) {
	 		my $ip = parsereceived($1);
	-		if ($ip && !Spamikaze::MXBackup($ip) ) {
	+		if ($ip && !Spamikaze::MXBackup($ip) && !whitelisted($ip)) {
	 			storeip($ip);
	 			return 1;
	 		}

	* spamikaze/scripts/passivetrap.pl:
	The function has been fixed to parse the Received: headers from many
	MTAs, long ago.  Time to clean up the function name.

	--- passivetrap.pl	6 Nov 2004 05:22:47 -0000	1.22
	+++ passivetrap.pl	6 Nov 2004 05:35:05 -0000
	@@ -55,7 +55,7 @@
	 	return 0;
	 }

	-sub received_to_ip_zmailer
	+sub received_to_ip
	 {
	 	my ( $rcvd ) = @_;

	@@ -74,7 +74,7 @@
	 {
	 	my ( $rcvd ) = @_;

	-	my $ip = &received_to_ip_zmailer($rcvd);
	+	my $ip = &received_to_ip($rcvd);

	 	return $ip;
	 }

	* spamikaze/scripts/passivetrap.pl:
	Add some more regular expressions, to catch common mailing list
	manager mail and reduce the false positives.

	--- passivetrap.pl	3 Aug 2004 03:47:08 -0000	1.21
	+++ passivetrap.pl	6 Nov 2004 05:21:56 -0000
	@@ -39,6 +39,18 @@
	 	if ($mail =~ /^From:\s+\<?postmaster/mi) {
	 		return 1;
	 	}
	+	if ($mail =~ /^From:\s+\<?(majordomo|listar|ecartis|mailman)/mi) {
	+		return 1;
	+	}
	+	if ($mail =~ /^From:\s+\<?(\w+-owner|owner-|\w+-request)/mi) {
	+		return 1;
	+	}
	+	if ($mail =~ /^From:?\s+\<?(bounce-.*@.*(lyris|list|mail))/mi) {
	+		return 1;
	+	}
	+	if ($mail =~ /^Your (mail to|message|email).*could not be delivered/m) {
	+		return 1;
	+	}

	 	return 0;
	 }

2004-10-31  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/rbldnsd.pl:
	Script to generate zone files for rbldnsd, a fast and efficient dns
	server for dnsbls.  See http://www.corpit.ru/mjt/rbldnsd/

2004-10-30  Rik van Riel  <riel@humbolt>

	* html/doc/install.php: it's DBD::mysql not DBI::mysql

2004-10-12  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: *** empty log message ***

	* ChangeLog: ChangeLog Updated

2004-10-12  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2004-09-15  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

	* ChangeLog: New ChangeLog started
	see for history  Changelog-pre-version-0.1 and ChangeLog-pre-version-0.2

	* ChangeLog: *** empty log message ***

	* ChangeLog-pre-version-0.2: renamed  ChangeLog to pre-version-0.2
	started new ChangeLog

	* ChangeLog: ChangeLog Updated

2004-09-15  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

	* ChangeLog: New ChangeLog started
	see for history  Changelog-pre-version-0.1 and ChangeLog-pre-version-0.2

	* ChangeLog: *** empty log message ***

	* ChangeLog-pre-version-0.2: renamed  ChangeLog to pre-version-0.2
	started new ChangeLog

	* ChangeLog: ChangeLog Updated

2004-09-15  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: New ChangeLog started
	see for history  Changelog-pre-version-0.1 and ChangeLog-pre-version-0.2

	* ChangeLog: *** empty log message ***

	* ChangeLog-pre-version-0.2: renamed  ChangeLog to pre-version-0.2
	started new ChangeLog

	* ChangeLog: ChangeLog Updated
