2005-09-08  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/Spamikaze.pm:
	whitespace (really just to test cvsmail)

2005-09-07  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/Spamikaze/PgSQL_3.pm:
	remove unused variable, clean up whitespace

	* spamikaze/scripts/Spamikaze/PgSQL_3.pm, spamikaze/scripts/Spamikaze.pm:
	Using this rule, the INSERT in ->storeip() will never really fail and we
	can get rid of the failure handling code in perl.  We can also reenable
	DBI's printing of failures.

	CREATE OR REPLACE RULE upsert AS
		ON INSERT TO blocklist
		WHERE (EXISTS ( SELECT 1 FROM blocklist WHERE ip = NEW.ip))
		DO INSTEAD
			UPDATE blocklist SET expires = NEW.expires
				WHERE ip = NEW.ip

2005-09-06  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/Spamikaze.pm:
	quiet the passivetrap output a bit, set PrintError to 0

	* spamikaze/scripts/Spamikaze/PgSQL_3.pm:
	check the returned value from ->execute explicitly

	* spamikaze/cgi-bin/listing.cgi, spamikaze/scripts/Spamikaze/MySQL_2.pm:
	Move time conversion into the database module.  This way we won't have
	to do double conversion in order to make postgres work.  Both mysql and
	postgresql now seem to work fine.

	diff -u -d -u -r1.12 listing.cgi
	--- cgi-bin/listing.cgi	4 Jul 2005 20:05:57 -0000	1.12
	+++ cgi-bin/listing.cgi	6 Sep 2005 12:50:02 -0000
	@@ -142,8 +142,7 @@

	 	my $foundinfo = ' ';
	 	foreach $time (sort keys %iplog) {
	-		my $printtime = gmtime($time);
	-		$foundinfo .= "<tr><td>$printtime</td>" .
	+		$foundinfo .= "<tr><td>$time</td>" .
	 				"<td>$iplog{$time}</td></tr>\n";
	 	}

	diff -u -d -u -r1.7 MySQL_2.pm
	--- scripts/Spamikaze/MySQL_2.pm	25 Aug 2005 04:09:24 -0000	1.7
	+++ scripts/Spamikaze/MySQL_2.pm	6 Sep 2005 12:50:02 -0000
	@@ -264,6 +264,7 @@
	 	$sth->bind_columns(undef, \$time);
	 	while ($sth->fetch()) {
	 		$found++;
	+		$time = gmtime($time);
	 		$iplog{$time} = 'spamtrap hit';
	 	}
	 	$sth->finish();
	@@ -282,6 +283,7 @@
	 	$sth->bind_columns(undef, \$time);
	 	while ($sth->fetch()) {
	 		$found++;
	+		$time = gmtime($time);
	 		$iplog{$time} = 'removed from list';
	 	}
	 	$sth->finish();

	* spamikaze/scripts/Spamikaze/PgSQL_3.pm:
	fix quoting so remove.cgi works

	* spamikaze/scripts/Spamikaze/PgSQL_3.pm:
	add pointer to schemas/spamikaze-pgsql-3.sql

	* spamikaze/scripts/named.pl: s/dienice/nice/ - now it behaves

	* spamikaze/scripts/Spamikaze/PgSQL_3.pm:
	fix quoting in remove_from_blocklist function

	* spamikaze/scripts/Spamikaze/PgSQL_3.pm, spamikaze/scripts/Spamikaze.pm:
	ok, now things seem to work

	* spamikaze/scripts/Spamikaze/PgSQL_3.pm:
	add new (untested) postgres schema and database module

	* spamikaze/country.sql, spamikaze/fqdn.sql, spamikaze/latest.sql, spamikaze/spamikaze-mysql.sql, spamikaze/spamikaze-mysql-update.sql, spamikaze/spamikaze-pg.sql:
	move database schemas to schemas/ directory

2005-09-04  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2005-09-03  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/smtperror-exim:
	make smtperror-exim also query the whitelists

	* spamikaze/scripts/passivetrap.pl:
	convert passivetrap to using the whitelist function in Spamikaze.pm

	* spamikaze/scripts/Spamikaze.pm: oops, Spamikaze.pm is not an object

	* spamikaze/scripts/Spamikaze.pm:
	add whitelisted function to Spamikaze.pm

2005-09-03  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/smtperror-exim:
	make smtperror-exim also query the whitelists

	* spamikaze/scripts/passivetrap.pl:
	convert passivetrap to using the whitelist function in Spamikaze.pm

	* spamikaze/scripts/Spamikaze.pm: oops, Spamikaze.pm is not an object

	* spamikaze/scripts/Spamikaze.pm:
	add whitelisted function to Spamikaze.pm

2005-08-25  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/Spamikaze.pm, spamikaze/scripts/Spamikaze/MySQL_2.pm:
	do not use autocommit

	* spamikaze/scripts/smtperror-exim: fix typo

2005-08-01  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2005-07-11  Rik van Riel  <riel@humbolt>

	* spamikaze/config/config.ini.example:
	add Schema=MySQL_2 to the example config file

2005-07-11  Rik van Riel  <riel@humbolt>

	* spamikaze/config/config.ini.example:
	add Schema=MySQL_2 to the example config file

2005-07-05  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

	Due to new Database-abstaction layer.

2005-07-05  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/Spamikaze/MySQL_2.pm, spamikaze/scripts/passivetrap.pl, spamikaze/scripts/smtperror-exim:
	pass a reason for storing the IP address to db->storeip()

2005-07-05  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/Spamikaze/MySQL_2.pm, spamikaze/scripts/passivetrap.pl, spamikaze/scripts/smtperror-exim:
	pass a reason for storing the IP address to db->storeip()

2005-07-04  Rik van Riel  <riel@humbolt>

	* spamikaze/cgi-bin/remove.cgi: whitespace and logic inversion

	* spamikaze/cgi-bin/listing.cgi:
	Openrbl.org is dead.  Use dnsstuff.com by default.

	diff -u -d -u -r1.11 listing.cgi
	--- listing.cgi	4 Jul 2005 19:54:55 -0000	1.11
	+++ listing.cgi	4 Jul 2005 20:05:23 -0000
	@@ -24,6 +24,9 @@
	 	$listname = $Spamikaze::web_listname;
	 }

	+# URL to check whether the IP is listed in other DNSBLs
	+my $checkurl = "http://www.dnsstuff.com/tools/ip4r.ch?ip=";
	+
	 sub write_page
	 {
	 	my ( $ip, $body ) = @_;
	@@ -87,16 +90,15 @@
	 	if ($foundinfo eq ' ') {
	 		$body = "The host $ip has never been listed in $listname. " .
	 			"Maybe you are looking at the wrong blocklist? " .
	-			"You may want to visit " .
	-			"<a href=\"http://openrbl.org/lookup?i=$ip\">Openrbl" .
	-			"</a> to check the other blocklists.";
	+			"<p>You may want to check the <a href=" .
	+			$checkurl . $ip . ">other blocklists</a>";
	 	} else {
	 		$body = "Currently listed in $listname?  $listedword.\n<p>" .
	 			"Spam and removal history for $ip (times in UTC):\n" .
	 			"<p><table border=\"1\">\n" . "$foundinfo" .
	 			"</table>\n" .
	-			"<p>Check this IP address in: " .
	-			"<a href=\"http://openrbl.org/lookup?i=$ip\">Openrbl" .
	+			"<p>You may also want to check the <a href=" .
	+			$checkurl . $ip . ">other blocklists</a>" .
	 			"</a> and " .
	 			"<a href=\"http://groups.google.com/groups?scoring=d&q=$ip+group:*abuse*\">Google groups</a>.\n" .
	 			"<h2>Remove IP from $listname</h2>\n" .

	* spamikaze/cgi-bin/listing.cgi, spamikaze/scripts/Spamikaze/MySQL_2.pm:
	- Move listing.cgi database functions to the database module
	- Show whether the IP address is currently on the DNSBL
	- Various small fixes to listing.cgi

	 cgi-bin/listing.cgi          |   76 ++++++------------------------------------- scripts/Spamikaze/MySQL_2.pm |   75 ++++++++++++++++++++++++++++++++++++++++++
	 2 files changed, 86 insertions(+), 65 deletions(-)

	Index: cgi-bin/listing.cgi

	* spamikaze/cgi-bin/remove.cgi:
	use remove_from_db function from database module - this script is now database agnostic

	* spamikaze/scripts/Spamikaze/MySQL_2.pm:
	add remove_from_db function, fix up argument calling (first argument passed is , doh)

	* spamikaze/scripts/Spamikaze.pm:
	oops - undef makes the variable undefined, instead of testing like \!defined...

	* spamikaze/scripts/passivetrap.pl: escape @ in regexp

	* spamikaze/scripts/passivetrap.pl:
	More regular expressions for the from_daemon function.
	I should move these into a config file some day...

	diff -u -d -u -r1.28 passivetrap.pl
	--- passivetrap.pl	4 Jul 2005 14:57:48 -0000	1.28
	+++ passivetrap.pl	4 Jul 2005 17:13:09 -0000
	@@ -37,7 +37,7 @@
	 	if ($mail =~ /^From:?\s+\<?MAILER.DAEMON/mi) {
	 		return 1;
	 	}
	-	if ($mail =~ /^From:\s+\<?postmaster/mi) {
	+	if ($mail =~ /^From:?[\s\w\+\-\'\"]+\<?postmaster/mi) {
	 		return 1;
	 	}
	 	if ($mail =~ /^From:\s+\<?(majordomo|listar|ecartis|mailman)/mi) {
	@@ -49,7 +49,76 @@
	 	if ($mail =~ /^From:?\s+\<?(bounce-.*@.*(lyris|list|mail))/mi) {
	 		return 1;
	 	}
	+	if ($mail =~ /^X-AskVersion:.*paganini.net/m) {
	+		return 1;
	+	}
	+	if ($mail =~ /^using a program called Qurb which automatically/m) {
	+		return 1;
	+	}
	 	if ($mail =~ /^Your (mail to|message|email).*could not be delivered/m) {
	+		return 1;
	+	}
	+	if ($mail =~ /Message from InterScan Messaging Security Suite/m) {
	+		return 1;
	+	}
	+	if ($mail =~ /^ScanMail for Microsoft Exchange has detected/m) {
	+		return 1;
	+	}
	+	if ($mail =~ /^X-ChoiceMail-Registration-Request/m) {
	+		return 1;
	+	}
	+	if ($mail =~ /^Subject:(\w\s)*automat(ic|ed) reply/mi) {
	+		return 1;
	+	}
	+	if ($mail =~ /^List-Subscribe:.*@/mi) {
	+		return 1;
	+	}
	+	if ($mail =~ /out of (the )?office/mi) {
	+		return 1;
	+	}
	+	if ($mail =~ /From?\s+(eSafe|MAILsweeper|av-gateway)@/m) {
	+		return 1;
	+	}
	+	if ($mail =~ /this is an automated (response|reply)/mi) {
	+		return 1;
	+	}
	+	if ($mail =~ /^Precedence:\s+(bulk|junk)/mi) {
	+		return 1;
	+	}
	+	if ($mail =~ /^Hi! This is the ezmlm program./m) {
	+		return 1;
	+	}
	+	if ($mail =~ /^Auto-Submitted:\sauto-replied/mi) {
	+		return 1;
	+	}
	+	if ($mail =~ /^From:?\s+Symantec_Anti-?(Spam|Virus)\@/mi) {
	+		return 1;
	+	}
	+	if ($mail =~ /^The following addresses had permanent fatal errors/mi) {
	+		return 1;
	+	}
	+	if ($mail =~ /VIRUS_WARNING|WORM_FOUND/m) {
	+		return 1;
	+	}
	+	if ($mail =~ /(Automatische Antwort|Abwesenheitsnotiz:)/m) {
	+		return 1;
	+	}
	+	if ($mail =~ /^Delivered-To:\s+Autoresponder/mi) {
	+		return 1;
	+	}
	+	if ($mail =~ /^Error 24: This message does not conform to our/mi) {
	+		return 1;
	+	}
	+	if ($mail =~ /Diagnostic-Code: X-Notes/mi) {
	+		return 1;
	+	}
	+	if ($mail =~ /The mail message.*contains a virus/mi) {
	+		return 1;
	+	}
	+	if ($mail =~ /^Your recent message to.*invalid/mi) {
	+		return 1;
	+	}
	+	if ($mail =~ /AppleID@apple.com/mi) {
	 		return 1;
	 	}

	* spamikaze/scripts/Spamikaze/MySQL_2.pm:
	add ORDER BY ipentries.id DESC LIMIT 200 to query, to limit results to a sane number

	* spamikaze/cgi-bin/remove.cgi, spamikaze/scripts/Spamikaze/MySQL_2.pm:
	global variables are evil

	* spamikaze/scripts/Spamikaze.pm:
	SplitIP further reduces code duplication with the cgi scripts

	* spamikaze/scripts/Spamikaze.pm: strict caught an error

	* spamikaze/cgi-bin/remove.cgi, spamikaze/scripts/Spamikaze.pm, spamikaze/scripts/Spamikaze/MySQL_2.pm:
	reduce code duplication some more

	* spamikaze/scripts/Spamikaze/MySQL_2.pm: typo

	* spamikaze/scripts/Spamikaze/MySQL_2.pm: oops - forgot a spot

	* spamikaze/scripts/Spamikaze/MySQL_2.pm, spamikaze/scripts/expire.pl, spamikaze/scripts/named.pl, spamikaze/scripts/passivetrap.pl, spamikaze/scripts/postfix.pl, spamikaze/scripts/rbldnsd.pl, spamikaze/scripts/smtperror-exim, spamikaze/scripts/text.pl, spamikaze/scripts/Spamikaze.pm:
	abstract database stuff into a module - code verified by Cor

2005-07-03  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2005-06-04  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2005-06-04  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2005-05-15  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/Spamikaze.pm:
	Make the configuration reloadable by sending SIGHUP to a Spamikaze
	program.  Useful for passivetrap -d and future Spamikaze daemons.

	TODO: make sure programs use the config values directly and not a
	(possibly out of date) local copy.

	diff -u -d -u -r1.23 Spamikaze.pm
	--- Spamikaze.pm	6 Nov 2004 21:00:10 -0000	1.23
	+++ Spamikaze.pm	15 May 2005 20:25:07 -0000
	@@ -57,7 +57,7 @@

	 my $VERSION = "Spamikaze.pm Version .2\n";

	-BEGIN {
	+sub ConfigLoad {

	 	my $configfile;

	@@ -175,6 +175,13 @@
	 	}

	 	return 0;
	+}
	+
	+BEGIN {
	+	&ConfigLoad();
	+
	+	# On SIGHUP we reload the configuration
	+	$SIG{HUP} = \&ConfigLoad;
	 }

	 1;

2005-05-15  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/Spamikaze.pm:
	Make the configuration reloadable by sending SIGHUP to a Spamikaze
	program.  Useful for passivetrap -d and future Spamikaze daemons.

	TODO: make sure programs use the config values directly and not a
	(possibly out of date) local copy.

	diff -u -d -u -r1.23 Spamikaze.pm
	--- Spamikaze.pm	6 Nov 2004 21:00:10 -0000	1.23
	+++ Spamikaze.pm	15 May 2005 20:25:07 -0000
	@@ -57,7 +57,7 @@

	 my $VERSION = "Spamikaze.pm Version .2\n";

	-BEGIN {
	+sub ConfigLoad {

	 	my $configfile;

	@@ -175,6 +175,13 @@
	 	}

	 	return 0;
	+}
	+
	+BEGIN {
	+	&ConfigLoad();
	+
	+	# On SIGHUP we reload the configuration
	+	$SIG{HUP} = \&ConfigLoad;
	 }

	 1;

2005-05-15  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/Spamikaze.pm:
	Make the configuration reloadable by sending SIGHUP to a Spamikaze
	program.  Useful for passivetrap -d and future Spamikaze daemons.

	TODO: make sure programs use the config values directly and not a
	(possibly out of date) local copy.

	diff -u -d -u -r1.23 Spamikaze.pm
	--- Spamikaze.pm	6 Nov 2004 21:00:10 -0000	1.23
	+++ Spamikaze.pm	15 May 2005 20:25:07 -0000
	@@ -57,7 +57,7 @@

	 my $VERSION = "Spamikaze.pm Version .2\n";

	-BEGIN {
	+sub ConfigLoad {

	 	my $configfile;

	@@ -175,6 +175,13 @@
	 	}

	 	return 0;
	+}
	+
	+BEGIN {
	+	&ConfigLoad();
	+
	+	# On SIGHUP we reload the configuration
	+	$SIG{HUP} = \&ConfigLoad;
	 }

	 1;

2005-05-14  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/passivetrap.pl:
	Avoid error messages like "Duplicate entry '206-51-237-82' for key 2".
	Patch by Jeroen van Nieuwenhuizen, verified to work here.

2005-05-04  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2005-04-03  Rik van Riel  <riel@humbolt>

	* html/menu.inc.php: link in the wiki

2005-04-02  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2005-04-03  Rik van Riel  <riel@humbolt>

	* html/menu.inc.php: link in the wiki

2005-04-02  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2005-03-28  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated


2005-03-28  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2005-03-05  Hans Wolters  <h-wolters@humbolt>

	* spamikaze/scripts/daemon.pl:
	Using the Spamikaze.pm to handle connections to the database

	* spamikaze/scripts/daemon.pl:
	K, this is the first public entrie for the daemon.

	What does it do:

	1. Delete entries older then one year (250 entries per run).
	2. Handle the expire (maximum of 500 ipnumbers per run).

	Please backup your stuff before you testdrive this and make sure
	it has the correct settings for the Spamikaze.pm, etc....

	Enjoy,

	Hans

2005-03-05  Hans Wolters  <h-wolters@humbolt>

	* spamikaze/scripts/daemon.pl:
	Using the Spamikaze.pm to handle connections to the database

	* spamikaze/scripts/daemon.pl:
	K, this is the first public entrie for the daemon.

	What does it do:

	1. Delete entries older then one year (250 entries per run).
	2. Handle the expire (maximum of 500 ipnumbers per run).

	Please backup your stuff before you testdrive this and make sure
	it has the correct settings for the Spamikaze.pm, etc....

	Enjoy,

	Hans

2005-03-04  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2005-02-06  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/smtperror-exim:
	Recognise all of these formats of error message, instead of just the
	first one:

	2005-02-06 11:12:00 SMTP protocol violation: synchronization error (input sent without waiting for greeting): rejected connection from H=[80.51.119.253]

	2005-02-06 11:11:38 SMTP protocol violation: synchronization error (next input sent too soon): rejected "Mail From: <reichbloom@yahoo.com>" H=(localhost) [217.153.19.27] next input="Rcpt To: <dmitri_3@SPAMTRAPDOMAIN>\r\n"

	2005-02-06 11:12:00 SMTP protocol violation: synchronization error (next input sent too soon): rejected "HELO localhost" H=[217.238.99.186] next input="Mail From: <jackson@yahoo.com>\r\n"

	* spamikaze/scripts/rbldnsd.pl, spamikaze/scripts/smtperror-exim:
	script that checks for SMTP protocol violations and blocklists those hosts

2005-02-06  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/smtperror-exim:
	Recognise all of these formats of error message, instead of just the
	first one:

	2005-02-06 11:12:00 SMTP protocol violation: synchronization error (input sent without waiting for greeting): rejected connection from H=[80.51.119.253]

	2005-02-06 11:11:38 SMTP protocol violation: synchronization error (next input sent too soon): rejected "Mail From: <reichbloom@yahoo.com>" H=(localhost) [217.153.19.27] next input="Rcpt To: <dmitri_3@SPAMTRAPDOMAIN>\r\n"

	2005-02-06 11:12:00 SMTP protocol violation: synchronization error (next input sent too soon): rejected "HELO localhost" H=[217.238.99.186] next input="Mail From: <jackson@yahoo.com>\r\n"

	* spamikaze/scripts/rbldnsd.pl, spamikaze/scripts/smtperror-exim:
	script that checks for SMTP protocol violations and blocklists those hosts

2005-01-28  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2004-12-11  Rik van Riel  <riel@humbolt>

	* TODO: diff -u -d -u -r1.16 TODO
	--- TODO	11 Jul 2004 21:00:03 -0000	1.16
	+++ TODO	11 Dec 2004 21:20:08 -0000
	@@ -2,16 +2,11 @@


	 Before next release:
	-  * review the documentation for completeness and skip some of the older
	-    parts where users need to include the correct path.
	-  * test the current cvs tree on different machines.
	-  * make sure database handlers are closed to make sure it will not
	-    barf out rollbacks (older perl versions).
	+  * integrate the postgres code by devdas
	+  * add similar mysql code modularisation
	+  * integrate query statistics

	 For later versions:
	-  * Add whitelist mailserver table
	-  * Add whitelist zone file so more then one mailservers can use it
	-    within a company/org.
	   * Add evidence table
	   * the perl scripts in cgi-bin should be able to do the same as there
	     php ones.

2004-12-11  Rik van Riel  <riel@humbolt>

	* TODO: diff -u -d -u -r1.16 TODO
	--- TODO	11 Jul 2004 21:00:03 -0000	1.16
	+++ TODO	11 Dec 2004 21:20:08 -0000
	@@ -2,16 +2,11 @@


	 Before next release:
	-  * review the documentation for completeness and skip some of the older
	-    parts where users need to include the correct path.
	-  * test the current cvs tree on different machines.
	-  * make sure database handlers are closed to make sure it will not
	-    barf out rollbacks (older perl versions).
	+  * integrate the postgres code by devdas
	+  * add similar mysql code modularisation
	+  * integrate query statistics

	 For later versions:
	-  * Add whitelist mailserver table
	-  * Add whitelist zone file so more then one mailservers can use it
	-    within a company/org.
	   * Add evidence table
	   * the perl scripts in cgi-bin should be able to do the same as there
	     php ones.

2004-11-23  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2004-11-13  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/passivetrap.pl:
	Clean up the maildir handling a bit, since everybody who I talked to
	seems to be using unlink instead of rename.

	NOTE: this change also gets rid of looking in the incoming/ directory,
	now you will need to SPECIFY THE ACTUAL MAILDIR on the commandline!
	This is a slightly incompatible change, but nobody objected in the
	week since it was proposed, so ... ;)

	--- passivetrap.pl	6 Nov 2004 15:51:29 -0000	1.25
	+++ passivetrap.pl	13 Nov 2004 03:28:41 -0000
	@@ -178,17 +178,15 @@
	 sub process_dir
	 {
	 	my ( $dir ) = @_;
	-	my $indir = "$dir/incoming";
	 	my $count = 0;
	 	my $file;

	-	opendir INCOMING, "$indir" || die "$ARGV[-1] : can't opendir $indir\n";
	+	opendir INCOMING, "$dir" || die "$ARGV[-1] : can't opendir $dir\n";
	 	my @files = readdir INCOMING;
	 	closedir INCOMING;

	 	foreach $file (@files) {
	-		my $mailfile = "$indir/$file";
	-		my $archived = "$dir/archive/$file";
	+		my $mailfile = "$dir/$file";
	 		my $email;

	 		# skip directories and other non-files
	@@ -205,8 +203,8 @@
	 		read MAIL, $email, 10000;
	 		close MAIL;

	-		if (!rename $mailfile, $archived) {
	-			die "can't move $mailfile to $archived: $!\n";
	+		if (!unlink $mailfile) {
	+			die "cannot unlink $mailfile: $!\n";
	 		}

	 		&process_mail($email);
	@@ -218,7 +216,6 @@
	 sub maildir_daemon
	 {
	 	my ( $dir ) = @_;
	-	my $indir = "$dir/incoming";

	 	chdir $dir || die "$ARGV[-1] : couldn't chdir to $dir\n";

2004-11-13  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/passivetrap.pl:
	Clean up the maildir handling a bit, since everybody who I talked to
	seems to be using unlink instead of rename.

	NOTE: this change also gets rid of looking in the incoming/ directory,
	now you will need to SPECIFY THE ACTUAL MAILDIR on the commandline!
	This is a slightly incompatible change, but nobody objected in the
	week since it was proposed, so ... ;)

	--- passivetrap.pl	6 Nov 2004 15:51:29 -0000	1.25
	+++ passivetrap.pl	13 Nov 2004 03:28:41 -0000
	@@ -178,17 +178,15 @@
	 sub process_dir
	 {
	 	my ( $dir ) = @_;
	-	my $indir = "$dir/incoming";
	 	my $count = 0;
	 	my $file;

	-	opendir INCOMING, "$indir" || die "$ARGV[-1] : can't opendir $indir\n";
	+	opendir INCOMING, "$dir" || die "$ARGV[-1] : can't opendir $dir\n";
	 	my @files = readdir INCOMING;
	 	closedir INCOMING;

	 	foreach $file (@files) {
	-		my $mailfile = "$indir/$file";
	-		my $archived = "$dir/archive/$file";
	+		my $mailfile = "$dir/$file";
	 		my $email;

	 		# skip directories and other non-files
	@@ -205,8 +203,8 @@
	 		read MAIL, $email, 10000;
	 		close MAIL;

	-		if (!rename $mailfile, $archived) {
	-			die "can't move $mailfile to $archived: $!\n";
	+		if (!unlink $mailfile) {
	+			die "cannot unlink $mailfile: $!\n";
	 		}

	 		&process_mail($email);
	@@ -218,7 +216,6 @@
	 sub maildir_daemon
	 {
	 	my ( $dir ) = @_;
	-	my $indir = "$dir/incoming";

	 	chdir $dir || die "$ARGV[-1] : couldn't chdir to $dir\n";

2004-11-06  Rik van Riel  <riel@humbolt>

	* html/doc/config.php:
	remove the IgnoreBOGON documentation, add in documentation for WhitelistZones

	* spamikaze/config/config.ini.example, spamikaze/scripts/Spamikaze.pm:
	Remove the IgnoreBOGON code.  This functionality can easily be obtained
	by adding bogons.cymru.com to the WhitelistZones, so this code is no
	longer required.

	--- config/config.ini.example	6 Nov 2004 15:22:54 -0000	1.9
	+++ config/config.ini.example	6 Nov 2004 20:58:29 -0000
	@@ -16,8 +16,6 @@
	 [Mail]
	 # ignore RFC1918 (private) IP addresses, don't touch this
	 IgnoreRFC1918=1
	-# ignore unassigned IP addresses, often forged, but sometimes used by spammers
	-IgnoreBOGON=0
	 # IP addresses that should not be listed, like your own mail servers
	 BackupMX=1.2.3.4 2.3.4.5
	 # ignore mail that looks like bounce messages
	--- scripts/Spamikaze.pm	6 Nov 2004 15:22:54 -0000	1.22
	+++ scripts/Spamikaze.pm	6 Nov 2004 20:58:29 -0000
	@@ -27,7 +27,6 @@
	 my $dbtype;
	 my $dbhost;
	 my @MXBACKUP;
	-my $ignoreBOGON;
	 my $ignoreRFC1918;
	 our $ignorebounces;
	 our @whitelist_zones;
	@@ -91,7 +90,6 @@
	 	@MXBACKUP = split ( ' ', $cfg->val( 'Mail', 'BackupMX' ) );
	 	@whitelist_zones = split ( ' ', $cfg->val ( 'Mail', 'WhitelistZones' ) );
	 	$ignoreRFC1918 = $cfg->val( 'Mail', 'IgnoreRFC1918' );
	-	$ignoreBOGON   = $cfg->val( 'Mail', 'IgnoreBOGON' );
	 	$ignorebounces = $cfg->val( 'Mail', 'IgnoreBounces' );

	 	$firsttime = $cfg->val ( 'Expire', 'FirstTime' );
	@@ -152,40 +150,7 @@

	 	}

	-	#
	-	# Check if the spammer doesn't somehow managed to send from a
	-	# BOGON IP-address. The BOGON test includes RFC1918 test so
	-	# we can ignore RFC1918 if we test for BOGON.
	-	#
	-	if ( $ignoreBOGON eq 'true' or $ignoreBOGON == 1) {
	-
	-		my $reversed_ip = $ip;
	-		$reversed_ip =~ s/^(\d+)\.(\d+)\.(\d+)\.(\d+)$/$4.$3.$2.$1/;
	-		my $resolver = Net::DNS::Resolver->new;
	-		my $query    = $resolver->search("$reversed_ip.bogons.cymru.com.");
	-
	-		if ($query) {
	-
	-			foreach my $rr ( $query->answer ) {
	-
	-				next unless $rr->type eq "A";
	-				return 1;
	-
	-			}
	-
	-		}
	-		else {
	-
	-			if ( !$resolver->errorstring =~ /NXDOMAIN/ ) {
	-
	-				warn "query failed: ", $resolver->errorstring, "\n";
	-
	-			}
	-
	-		}
	-
	-	}
	-	elsif ( $ignoreRFC1918 eq 'true' or $ignoreRFC1918 == 1 ) {
	+	if ( $ignoreRFC1918 eq 'true' or $ignoreRFC1918 == 1 ) {

	 		foreach my $ipaddress (@RFC1918Addresses) {

	* spamikaze/scripts/passivetrap.pl: whitespace cleanup

	* spamikaze/config/config.ini.example, spamikaze/scripts/Spamikaze.pm, spamikaze/scripts/passivetrap.pl:
	Allow Spamikaze to use (external) DNS whitelists to avoid listing high
	volume mail servers.  This can help keep the false positives of your
	Spamikaze setup down.

	--- config/config.ini.example	29 Jun 2004 11:42:25 -0000	1.8
	+++ config/config.ini.example	6 Nov 2004 15:20:34 -0000
	@@ -22,6 +22,8 @@
	 BackupMX=1.2.3.4 2.3.4.5
	 # ignore mail that looks like bounce messages
	 IgnoreBounces=1
	+# whitelist(s) of known-good mail servers, to never block
	+WhitelistZones=whitelist.surriel.com whitelist.example.tld

	 [Expire]
	 # time (in hours) the first spam causes a host to be blocked
	--- scripts/Spamikaze.pm	29 Aug 2004 01:22:52 -0000	1.21
	+++ scripts/Spamikaze.pm	6 Nov 2004 15:20:34 -0000
	@@ -30,6 +30,7 @@
	 my $ignoreBOGON;
	 my $ignoreRFC1918;
	 our $ignorebounces;
	+our @whitelist_zones;

	 # expire.pl
	 our $firsttime;
	@@ -88,6 +89,7 @@
	 	$dbbase = $cfg->val( 'Database', 'Name' );

	 	@MXBACKUP = split ( ' ', $cfg->val( 'Mail', 'BackupMX' ) );
	+	@whitelist_zones = split ( ' ', $cfg->val ( 'Mail', 'WhitelistZones' ) );
	 	$ignoreRFC1918 = $cfg->val( 'Mail', 'IgnoreRFC1918' );
	 	$ignoreBOGON   = $cfg->val( 'Mail', 'IgnoreBOGON' );
	 	$ignorebounces = $cfg->val( 'Mail', 'IgnoreBounces' );
	--- scripts/passivetrap.pl	6 Nov 2004 05:35:52 -0000	1.23
	+++ scripts/passivetrap.pl	6 Nov 2004 15:20:34 -0000
	@@ -14,6 +14,7 @@
	 use strict;
	 use warnings;
	 use FindBin;
	+use Net::DNS;
	 use lib "$FindBin::Bin";

	 use Spamikaze;
	@@ -139,6 +140,22 @@

	 }

	+sub whitelisted
	+{
	+	my ( $revip ) = @_;
	+	$revip =~ s/(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/$4.$3.$2.$1/;
	+	my $res = new Net::DNS::Resolver;
	+	my $zone;
	+
	+	foreach $zone (@Spamikaze::whitelist_zones) {
	+		my $query = $res->query($revip . "." . $zone, "A");
	+		if (defined $query) {
	+			return 1;
	+		}
	+	}
	+	return 0;
	+}
	+
	 sub process_mail
	 {
	 	my ( $mail ) = @_;
	@@ -149,7 +166,7 @@

	 	while ($mail =~ /Received:(.*?)(?=\n\w)/sg) {
	 		my $ip = parsereceived($1);
	-		if ($ip && !Spamikaze::MXBackup($ip) ) {
	+		if ($ip && !Spamikaze::MXBackup($ip) && !whitelisted($ip)) {
	 			storeip($ip);
	 			return 1;
	 		}

	* spamikaze/scripts/passivetrap.pl:
	The function has been fixed to parse the Received: headers from many
	MTAs, long ago.  Time to clean up the function name.

	--- passivetrap.pl	6 Nov 2004 05:22:47 -0000	1.22
	+++ passivetrap.pl	6 Nov 2004 05:35:05 -0000
	@@ -55,7 +55,7 @@
	 	return 0;
	 }

	-sub received_to_ip_zmailer
	+sub received_to_ip
	 {
	 	my ( $rcvd ) = @_;

	@@ -74,7 +74,7 @@
	 {
	 	my ( $rcvd ) = @_;

	-	my $ip = &received_to_ip_zmailer($rcvd);
	+	my $ip = &received_to_ip($rcvd);

	 	return $ip;
	 }

	* spamikaze/scripts/passivetrap.pl:
	Add some more regular expressions, to catch common mailing list
	manager mail and reduce the false positives.

	--- passivetrap.pl	3 Aug 2004 03:47:08 -0000	1.21
	+++ passivetrap.pl	6 Nov 2004 05:21:56 -0000
	@@ -39,6 +39,18 @@
	 	if ($mail =~ /^From:\s+\<?postmaster/mi) {
	 		return 1;
	 	}
	+	if ($mail =~ /^From:\s+\<?(majordomo|listar|ecartis|mailman)/mi) {
	+		return 1;
	+	}
	+	if ($mail =~ /^From:\s+\<?(\w+-owner|owner-|\w+-request)/mi) {
	+		return 1;
	+	}
	+	if ($mail =~ /^From:?\s+\<?(bounce-.*@.*(lyris|list|mail))/mi) {
	+		return 1;
	+	}
	+	if ($mail =~ /^Your (mail to|message|email).*could not be delivered/m) {
	+		return 1;
	+	}

	 	return 0;
	 }

2004-10-31  Rik van Riel  <riel@humbolt>

	* spamikaze/scripts/rbldnsd.pl:
	Script to generate zone files for rbldnsd, a fast and efficient dns
	server for dnsbls.  See http://www.corpit.ru/mjt/rbldnsd/

2004-10-30  Rik van Riel  <riel@humbolt>

	* html/doc/install.php: it's DBD::mysql not DBI::mysql

2004-10-12  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: *** empty log message ***

	* ChangeLog: ChangeLog Updated

2004-10-12  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

2004-09-15  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

	* ChangeLog: New ChangeLog started
	see for history  Changelog-pre-version-0.1 and ChangeLog-pre-version-0.2

	* ChangeLog: *** empty log message ***

	* ChangeLog-pre-version-0.2: renamed  ChangeLog to pre-version-0.2
	started new ChangeLog

	* ChangeLog: ChangeLog Updated

2004-09-15  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: ChangeLog Updated

	* ChangeLog: New ChangeLog started
	see for history  Changelog-pre-version-0.1 and ChangeLog-pre-version-0.2

	* ChangeLog: *** empty log message ***

	* ChangeLog-pre-version-0.2: renamed  ChangeLog to pre-version-0.2
	started new ChangeLog

	* ChangeLog: ChangeLog Updated

2004-09-15  Cor Gest  <cor@humbolt.nl.linux.org>

	* ChangeLog: New ChangeLog started
	see for history  Changelog-pre-version-0.1 and ChangeLog-pre-version-0.2

	* ChangeLog: *** empty log message ***

	* ChangeLog-pre-version-0.2: renamed  ChangeLog to pre-version-0.2
	started new ChangeLog

	* ChangeLog: ChangeLog Updated
