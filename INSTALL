MySQL
-----

Important. If you are updating from the previous version of Spamikaze
the please read the following. If not then move on to the install part 
of this document.

Update Spamikaze
----------------

To update from the Spamikaze version .1 you will need three extra
tables in the spamikaze database. This is simply done by importing
the update dump in mysql.

    mysql -u root -p spamikaze < spamikaze-mysql-update.sql

Next you need to make sure you have a backup of your current database
before you run the update script which is located in the scripts 
directory. This update will import the current entries which are all
stored in the spammers table into the ipnumber and ipentries tables.


Install Spamikaze
-----------------

We are assuming you already have mysql installed and running. If not
then please get a version for your OS and install it with the guide-
lines of that package.

* Creating a new database for spamikaze:

At the prompt you can use mysqladmin to create a new database.

    mysqladmin -u root -p create spamikaze 

You will be prompted for the mysql root password, enter it. If no
errors are shown you need to login as mysql root to the database
server in order to grant privileges to the new spamikaze directory:

    mysql -u root -p mysql

Again you will be prompted for a password, enter it.

Once you are in you should grant privileges with to a user at either 
localhost or a webserver able to access this mysql server. It is not
recommended to use a remote server without using some sort of encryption.
The following example will use user spamikaze at localhost. You need to
grant select, insert and update privileges at least. It is recommended 
to hold back any other privileges at this time:

mysql> GRANT SELECT, INSERT, UPDATE ON spamikaze.* TO
        spamikaze@localhost IDENTIFIED BY 's0m3leetpassw0rd';

Once this is done you only need to flush the privileges:

mysql> FLUSH PRIVILEGES;

The last thing to do with mysql is read the spamikaze-sf.sql into the newly
created database.

    mysql -u root -p spamikaze < /path/spamikaze-mysql.sql

Again you will be prompted for a password, enter it.


Webserver
---------

The most common webserver around for the *nix platform is Apache. To run
either the cgi or the php 4 scripts you will have to make sure apache can
handle them. 

The php scripts are using the newly introduced superglobals and can be run
with register_globals set off:

http://nl3.php.net/manual/en/language.variables.predefined.php


For installation guides on both Apache and PHP please see the following url's:

http://nl3.php.net/manual/en/installation.php
http://httpd.apache.org/


Spamikaze 
---------

Setting up the scripts:

The first thing you need to do is check the location of the perl shebang.
Spamikaze uses #!/usr/bin/perl. If it isn't located there you will either
have to links perl to that location or alter the shebangs in all the perl
scripts. For the php files you will use you will need to edit the 
include_once location to point it to the correct config.php.

Next choose a location where the scripts could be located on your system.
Copy config.php, passivetrap.pl, sendmail.pl and named.pl to that location.

Store the php/cgi scripts in your webdir/cgi-bin.

Currently the php files use a centralized config which is called config.php.
The following perl files should be altered by hand. 


   config.pl
   ---------

   These are the user, database and the password you entered configuring
   mysql or postgres. Also the hostname, the portnumber for the databaseserver,
   the dbtype variable and the @MXBACKUP is located there.

   Some extra info on this.

   our $dbuser  The user with privileges to connect to the dbserver.
   our $dbpwd   The password for the $dbuser to connect to the dbserver.
   our $dbbase  The database within the dbserver where spamikaze will store its data.
   our $dbhost  The machine name where the dbserver is hosted.
   our $dbport  Either 3306 as default for mysql or 5432 as the default postgresql port.
                The portnumber could be altered by you sysop.

   our @MXBACKUP

   This is a list of mx hosts that will not be trapped by passivetrap, once
   email is received it will skip them and look for an ip number outside
   of that list.

   WARNING: if you do not configure this right, you could end up blocking
   your own mail server! Double-check that you get this complete, then check
   again...

   passivetrap.pl, sendmail.pl, named.pl, listing.cgi, remove.cgi
   --------------------------------------------------------------
  
   require "/path/config.pl";
  
   This should point to the correct location.


   sendmail.pl
   -----------
   my $ticks               = 30 * 24 * 60 * 60;  # 30 days ?
   my $mta_bl_location     = "/tmp/test";
   my $mta_bl_template     = "{IP}\tREJECT";
   my $mta_bl_template_wl  = "{EMAIL}";

   $ticks               the number of days the ipnumber will be blocked.
   $mta_bl_location     the location of you access file 
   $mta_bl_template     the error message that will be presented to blocked 
                        ipnumbers. You can mention the location of the
                        remove.php/cgi (complete url) if you wish to enable
                        the delisting.
   $mta_bl_template_wl  used to store the email address of persons that
                        wish to be whitelisted.

   check the exec line at the end of this script to see if the access
   and the makemap location are the correct ones.
  

   named.pl
   --------

   require "/path/config.pl";

   Make sure it points to the correct location.
   
   $zone_header = ...

   Here you add your zone name, SOA record, name servers and everything
   else you would put in a bind style zone file.  Expect an easier
   configuration here in a next version.

   $ticks               = 30 * 24 * 60 * 60;

   By default spamikaze expires a listing after 30 days.

   $mta_bl_location     = "/var/named/spamikaze.zone";
   $mta_bl_a            = "{IP}\t300\tIN\tA\t127.0.0.2";
   $mta_bl_txt          = "\t\t\tIN\tTXT\t\"http://spamikaze.yourdomain.tld/listing.php?{IP}\"";

   The location of the zone file speaks for itself and you shouldn't
   need to configure the A record for the zone entries.  The TXT record
   needs to be edited so you point to your spamikaze website; you also
   need to change it if you want to use the cgi scripts instead of the
   php script.

Almost done, setting up the spamtraps and cronjobs: 

a. Setting up spamtraps using aliases in your /etc/aliases by piping them
   to passivetrap.pl. An example:

passive:        |/path/passivetrap.pl

nomailwanted: passive
MUNGED: passive
uns:    passive

Once you run newaliases it will use passivetrap to handle all incoming mail.


Importing older spam:
---------------------

With formail you can import your current spamarchive into the database server:

    formail -s /path/passivetrap.pl < /path/spamarchive

On older machines it might take a long time, depending on the number of
spams and your hardware.

If you wish to import mail from different files then the following shellcode
will enable you to do it:

for I in *
        do
                formail -s /path/passivetrap.pl < $I
        done

Enjoy,

The Spamikaze team.
