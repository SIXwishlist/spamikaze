		Database reorganisation
		$Id: TODO-database,v 1.2 2004/04/17 01:34:53 riel Exp $


In order to facilitate more flexible blocklisting, expiry, removal and
whitelisting policies, a database redesign is necessary.  Before we can
come up with such a new design, however, we should think about exactly
what we want to store in the database.

The new database layout will look something like this:

CREATE TABLE ipentries (
  id int(11) NOT NULL auto_increment,
  date_received timestamp(14) NOT NULL,
  date_logged timestamp(14) NOT NULL,
  date_mail timestamp(14) NOT NULL,
  id_subject int(11) NOT NULL default '0',
  id_ip int(11) NOT NULL default '0',
  PRIMARY KEY  (id),
  UNIQUE KEY idx_spamentry (date_received,date_logged,date_mail)
);
 
CREATE TABLE ipnumbers (
  id int(11) NOT NULL auto_increment,
  octa smallint(6) NOT NULL default '0',
  octb smallint(6) NOT NULL default '0',
  octc smallint(6) NOT NULL default '0',
  octd smallint(6) NOT NULL default '0',
  PRIMARY KEY  (id),
  UNIQUE KEY idx_ip (octa,octb,octc,octd)
);
 
CREATE TABLE subjects (
  id int(11) NOT NULL auto_increment,
  subject varchar(150) NOT NULL default '',
  PRIMARY KEY  (id),
  UNIQUE KEY idx_subject (subject)
);


To take the IP addresses from the (old) spammers table and put them
into the ipnumbers table, use the following command (MySQL); the
IGNORE is needed in some versions of mysql because otherwise it will
return an error on the first duplicate encountered, instead of
discarding the duplicates like we want.

INSERT IGNORE INTO ipnumbers (octa, octb, octc, octd) select octa, octb, octc, octd FROM spammers;
